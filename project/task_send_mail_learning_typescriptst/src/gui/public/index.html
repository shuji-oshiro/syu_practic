<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ToDoリスト</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    ul { padding-left: 0; list-style: none; }
    li { padding: 0.5em 0; }
    .todo-list {
      list-style: none;
      padding: 0;
    }
    .todo-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      border-bottom: 1px solid #ccc;
    }
    .todo-title.done {
      text-decoration: line-through;
      color: #888;
    }
    .delete-button {
      background: none;
      border: none;
      cursor: pointer;
      color: #888;
    }
  </style>
  <link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
  crossorigin="anonymous"
  />
</head>
<body>
  <div class="container mt-4">
    <h1 class="mb-4">ToDoリスト</h1>
    
    <div class="mb-4">
      <select id="filter-select" class="form-select" onchange="loadTodos()">
        <option value="all">すべてALL</option>
        <option value="undone">未完了</option>
        <option value="done">完了済</option>
      </select>
    </div>

    <ul id="todo-list" class="list-group mb-4"></ul>

    <div class="card">
      <div class="card-body">
        <h2 class="card-title h4 mb-3">新しいToDoを追加</h2>
        <div class="row g-3">
          <div class="col-md-6">
            <input type="text" id="todo-input" class="form-control" placeholder="やることを入力" />
          </div>
          <div class="col-md-2">
            <button onclick="addTodo()" class="btn btn-primary w-100">追加</button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script>

    //初期処理　タスク情報を取得し画面に表示する
    async function loadTodos() {
      const filterSelect = document.getElementById('filter-select');
      const filter = filterSelect.value;
      console.log("call!! loadTodos",filter);
      const res = await fetch(`/todos?filter=${filter}`);
      const todos = await res.json();
      const list = document.getElementById('todo-list');
      list.innerHTML = '';

      // タイトルごとにグループ化
      const groupedTodos = todos.reduce((acc, todo) => {
        if (!acc[todo.title]) {
          acc[todo.title] = [];
        }
        acc[todo.title].push(todo);
        return acc;
      }, {});

      // グループ化されたToDoを表示
      Object.entries(groupedTodos).forEach(([title, todoGroup]) => {
        // リストアイテムの作成
        const li = document.createElement('li');
        li.className = 'list-group-item';
        
        // ヘッダー部分（タイトルとチェックボックス）
        const header = document.createElement('div');
        header.className = 'd-flex justify-content-between align-items-center mb-2';
        
        

        // タイトルの作成
        const titleSpan = document.createElement('span');
        titleSpan.textContent = title;
        titleSpan.className = 'flex-grow-1 ms-2';
        titleSpan.contentEditable = true;
        
        // エンターキーとタブキーが押された時の処理を追加
        titleSpan.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === 'Tab') {
            // e.preventDefault(); // デフォルトの改行を防止
            // const newTitle = titleSpan.textContent.trim(); // 前後の空白を削除
            // if (newTitle && newTitle !== title) {
            //   updateTodoTitle({oldTitle: title, newTitle: newTitle});
            // } else {
            //   // 無効な入力の場合は元のタイトルに戻す
            //   titleSpan.textContent = title;
            // }
            titleSpan.blur(); // フォーカスを外す
          }
        });

        // フォーカスを外した時の処理
        titleSpan.addEventListener('blur', () => {
          const newTitle = titleSpan.textContent.trim(); // 前後の空白を削除
          if (newTitle && newTitle !== title && updateTodoTitle({oldTitle: title, newTitle: newTitle})) {
            titleSpan.textContent = newTitle;
          }else{
            titleSpan.textContent = title;
          }
        });
       

        // メールアドレス選択用のコンボボックスを作成
        const emailSelect = document.createElement('select');
        emailSelect.className = 'form-select form-select-sm ms-2';
        emailSelect.style.width = '200px';
        
        // デフォルトのメールアドレスを追加
        const defaultEmails = ['test@example.com', 'test2@example.com', 'test3@example.com'];
        defaultEmails.forEach(email => {
          const option = document.createElement('option');
          option.value = email;
          option.textContent = email;
          emailSelect.appendChild(option);
        });


        // 削除ボタンの作成
        const deleteButton = document.createElement('button');
        deleteButton.textContent = '✖';
        deleteButton.className = 'btn btn-sm btn-danger ms-2';
        deleteButton.onclick = () => deleteTodo({title: title});


        // 追加ボタンの作成
        const addButton = document.createElement('button');
        addButton.textContent = '追加';
        addButton.className = 'btn btn-sm btn-danger ms-2';
        addButton.onclick = () => {
          const selectedEmail = emailSelect.value;
          add_address_to_todo({title: title, email: selectedEmail});
        };
      
        
        // header.appendChild(checkbox);
        header.appendChild(titleSpan);
        header.appendChild(emailSelect);
        header.appendChild(addButton);
        header.appendChild(deleteButton);
        
        
        // メールアドレスリストの作成
        const emailList = document.createElement('div');
        emailList.className = 'ms-4';
        todoGroup.forEach(todo => {
          const emailContainer = document.createElement('div');
          emailContainer.className = 'd-flex justify-content-between align-items-center mb-1';
          
          const emailItem = document.createElement('div');
          emailItem.className = 'text-muted small';
          emailItem.textContent = todo.email;
          
          const emailDeleteButton = document.createElement('input');
          emailDeleteButton.type = 'checkbox';
          emailDeleteButton.className = 'form-check-input';
          emailDeleteButton.checked = todo.done;
          emailDeleteButton.onchange = () => toggleTodo({title: todo.title, done: emailDeleteButton.checked, email: todo.email});
          
          emailContainer.appendChild(emailItem);
          emailContainer.appendChild(emailDeleteButton);
          emailList.appendChild(emailContainer);
        });
        
        li.appendChild(header);
        li.appendChild(emailList);
        list.appendChild(li);
      });
    }

    //タスクのタイトルを更新する処理　同じタイトルのタスクは更新しない
    function updateTodoTitle({id, oldTitle, newTitle}) {
      
      const response = fetch(`/todos/updateTitle`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, oldTitle, newTitle })
      })
        .then(response => {
          if (!response.ok) {
            return response.text().then(text => {
              throw new Error(text);
            });
          }
          return response.json();
        })
        .then(data => {
          console.log(data);
          loadTodos();
        })
        .catch(error => {
          alert('エラー: ' + error.message);
        });
      
    }

    //タスクにメールアドレスを追加する処理　すでに
    function add_address_to_todo({title,email}) {
      console.log("add_address_to_todo",title,email);
      fetch('/todos/add_address_to_todo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({title, email })
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => {
            throw new Error(text);
          });
        }
        return response.json();
      })
      .then(data => {
        console.log(data);
        loadTodos();
      })
      .catch(error => {
        alert('エラー: ' + error.message);
      });
    }

    //タスクを削除する処理
    function deleteTodo({title}) {
      if (!confirm(`「${title}」を削除してもよろしいですか？`)) {
        return;
      }
      fetch(`/todos/delete`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title })
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => {
            throw new Error(text);
          });
        }
        return response.json();
      })
      .then(data => {
        console.log(data);
        loadTodos();
      })
      .catch(error => {
        alert('エラー: ' + error.message);
      });
    }


    //メールアドレス単位でタスクを完了にする処理
    function toggleTodo({title,done,email}) { 
      
      fetch(`/todos/toggle`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, done, email })
      })
        .then(() => loadTodos()); // 更新して再表示
    }


    //タスクを追加する処理　初期処理では登録されているメールアドレスすべてにタスクを追加する
    function addTodo() {
      const input = document.getElementById('todo-input');
      // const email = document.getElementById('email');
      const title = input.value;
      // const emailValue = email.value;
      if (!title) return;
      fetch('/todos/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title })
      })
        .then(() => loadTodos()); // 更新して再表示
      input.value = '';
      email.value = '';
    } 


    loadTodos();
  </script>
</body>
</html>
