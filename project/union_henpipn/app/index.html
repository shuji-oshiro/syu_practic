<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>売上情報集計ツール</title>
</head>
<body>
    <h1>売上情報集計ツール</h1>
    <button onclick="uploadFile()">売上情報取得</button>
    
    <h2>店舗リスト</h2>
    <select id="storeList" size="10"></select>
    <button onclick="viewDetails()">詳細表示</button>

    <h2>商品別集計</h2>
    <select id="productDetails" size="20"></select>
    

    <script>
        async function uploadFile() {
            // ファイル選択処理を関数内で完結
            const fileInput = document.createElement('input');
            fileInput.type = 'file';

            // ファイル選択後の処理
            fileInput.onchange = async () => {
                const file = fileInput.files[0];

                if (!file) {
                    alert('ファイルを選択してください');
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    console.log("ファイル読み込みエラー発生', response.statusText);")
                    return;
                }

                const data = await response.json();
                
                const storeList = document.getElementById('storeList');
                storeList.innerHTML = '';

                if (data.length === 0) {
                    storeList.innerHTML = '<p>データがありません</p>';
                    return;
                }

                data.stores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.tenpo_name;
                    option.textContent = `${store.tenpo_name} (返品金額: ${store.re_amout}, 返品数量: ${store.re_count})`;
                    storeList.appendChild(option);
                });
            };

            // ファイル選択ダイアログを表示
            fileInput.click();
        }

        async function viewDetails() {
            const storeList = document.getElementById('storeList');
            const selectedStore = storeList.value;

            if (!selectedStore) {
                alert('店舗を選択してください');
                return;
            }

            const response = await fetch(`/api/details?store=${encodeURIComponent(selectedStore)}`);
            if (!response.ok) {
                console.log("詳細表示エラー発生', response.statusText);")
                return;
            }

            const productDetails = document.getElementById('productDetails');
            productDetails.innerHTML = '';

            const data = await response.json();

            data.products.forEach(product => { 
                const option = document.createElement('option');
                option.value = product.item_name;
                option.textContent = `${product.item_name} (返品金額: ${product.re_amout}, 返品数量: ${product.re_count})`;
                productDetails.appendChild(option);
            });
        }
    </script>
</body>
</html>
